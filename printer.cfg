# This file contains a configuration for the "Flsun Super Racer" delta printer with a MKS Robin Nano V3 board

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_420031001650314335393520-if00
restart_method: command

[printer]
kinematics: delta
max_velocity: 500
max_accel: 10000
max_z_velocity: 200
delta_radius = 151.594811
minimum_z_position: -20

[stepper_a]
step_pin: PE3
dir_pin: PE2
enable_pin: !PE4
rotation_distance: 80
homing_speed: 60
homing_retract_dist: 5
homing_retract_speed: 10
second_homing_speed: 2
microsteps: 16
endstop_pin: PA15
homing_speed: 60
angle = 209.488168
arm_length = 315.000000
position_endstop = 334.717944

[stepper_b]
step_pin: PE0
dir_pin: PB9
enable_pin: !PE1
rotation_distance: 80
microsteps: 16
endstop_pin: PD2
angle = 329.781289
arm_length = 315.000000
position_endstop = 335.157119

[stepper_c]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB8
rotation_distance: 80
microsteps: 16
endstop_pin: PC4
angle = 90.000000
arm_length = 315.000000
position_endstop = 335.589116

[extruder]
step_pin: PD6
dir_pin: !PD3
enable_pin: !PB3
rotation_distance: 44.880
gear_ratio: 50:17
microsteps: 16
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PE5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC1
control = pid
pid_kp = 21.495
pid_ki = 0.833
pid_kd = 138.645
min_extrude_temp: 160
min_temp: 0
max_temp: 300
max_extrude_only_distance: 500.0
pressure_advance = 0.53

[heater_bed]
heater_pin: PA0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC0
control = pid
pid_kp = 66.602
pid_ki = 1.410
pid_kd = 786.738
min_temp: 0
max_temp: 105

[fan]
pin: PC14

[heater_fan Heatblock_fan]
pin: PB0
heater: extruder
kick_start_time: 0.200

[probe]
pin: !PC8
#z_offset = 15.50
samples: 2
samples_tolerance: 0.02
samples_tolerance_retries: 15

[filament_switch_sensor filament-Sensor]
pause_on_runout: True
switch_pin: PA4

[idle_timeout]
timeout: 360

[delta_calibrate]
radius: 125
horizontal_move_z: 18
height0 = 15.5
height0_pos = 12786.000,12786.000,12786.000
height1 = 15.5
height1_pos = 15443.000,15443.000,11313.000
height2 = 15.5
height2_pos = 12463.000,16957.667,12463.000
height3 = 15.5
height3_pos = 11347.000,14977.333,14977.333
height4 = 15.5
height4_pos = 12383.000,12383.000,15626.000
height5 = 15.5
height5_pos = 14604.000,11446.000,14604.000
height6 = 15.5
height6_pos = 16267.333,12434.000,12434.000

[bed_mesh]
speed: 50
horizontal_move_z: 18
mesh_radius: 120
mesh_origin: 0,0
round_probe_count: 7
algorithm: bicubic

# Heater and temperature sensor verification. Heater verification is
# automatically enabled for each heater that is configured on the
# printer. Use verify_heater sections to change the default settings.
[verify_heater extruder]
heating_gain: 10
#   The minimum temperature (in Celsius) that the heater must increase
#   by when approaching a new target temperature. The default is 2.
check_gain_time: 20
#   The amount of time (in seconds) that the heating_gain must be met
#   in before an error is raised. The default is 20 seconds for
#   extruders and 60 seconds for heater_bed.
hysteresis: 5
#   The difference between the target temperature and the current
#   temperature for the heater to be considered within range of the
#   target temperature. The default is 5.
max_error: 120
#   The maximum temperature difference a heater that falls outside the
#   target temperature range may accumulate before an error is
#   raised. For example, if the target temperature is 200, the
#   hysteresis is 5, the max_error is 120, and the temperature is
#   reported at 185 degrees for 12 seconds then an error would be
#   raised (or 24 seconds at 190, or 120 seconds at 194, etc.). The
#   default is 120.

[virtual_sdcard]
path: ~/gcode_files

[display_status]

[pause_resume]

[gcode_macro START_PRINT]
# Reference https://github.com/KevinOConnor/klipper/blob/master/docs/Config_Reference.md#gcode_macroA
# On how to override default parameters
default_parameter_BED_TEMP: 55
default_parameter_EXTRUDER_TEMP: 200

gcode:
 # Home the printer
	G28
    #Probe Everytime
	;G29 
	#load saved mesh at print start instead of probe. Uncomment to use but comment out G29
	BED_MESH_PROFILE LOAD=default   					 
    # Use absolute coordinates
    G90
    ;PRIME_LINE
    # Move the nozzle near the bed
    ;G1 X0 Y0 Z5 F3000
    # Move the nozzle very close to the bed
    ;G1 Z0.15 F300
    G92 E0 ;Reset Extruder
   ; G1 X20 Y5 Z0.3 F5000.0			   
   ; G1 Z0.3 F1000 				    
    ;G1 X200 Y5 F1500.0 E15 			   
    ;G1 X200 Y5.3 Z0.3 F5000.0			    
    ;G1 X5.3  Y5.3 Z0.3 F1500.0 E30 			
    ;G1 Z3 F3000 				     
    ;G21 ; set units to millimeters
    ;G90 ; use absolute coordinates
    ;M83 ; use relative	distances for extrusion
    ;G92 E0
    
[gcode_macro END_PRINT]
gcode:
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # Move nozzle away from print while retracting
    G91
    G1 X-2 Y-2 E-3 F300
    # Raise nozzle by 10mm
    G1 Z30 F3000
    G90
    # Disable steppers
    M84

# Pause print macro
[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
default_parameter_X: 0    #edit to your park position
default_parameter_Y: 0    #edit to your park position
default_parameter_Z: 300     #edit to your park position
default_parameter_E: 1      #edit to your retract length
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-{E} F2100
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F6000

# Resume print macro
[gcode_macro RESUME]
rename_existing: BASE_RESUME
default_parameter_E: 1      #edit to your retract length
gcode:
    G91
    G1 E{E} F2100
    G90
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    BASE_RESUME

# Cancel print macro
[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT

[gcode_macro M851]
gcode:
  G28
  probe_calibrate

[gcode_macro G32]
gcode:
  G28
  delta_calibrate
  G1 X0 Y0 F4200
  save_config

[gcode_macro G29]
gcode:
  G28
  bed_mesh_calibrate
  G1 X0 Y0 Z15 F4200
  save_config

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 15.450
#*#
#*# [printer]
#*#
#*# [stepper_a]
#*#
#*# [stepper_b]
#*#
#*# [stepper_c]
#*#
#*# [delta_calibrate]
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.135393, 0.135393, 0.135393, 0.135393, 0.135393, 0.135393, 0.135393
#*# 	0.002402, 0.002402, -0.023960, -0.032966, -0.029499, -0.042822, -0.042822
#*# 	-0.057906, -0.057906, -0.016066, -0.015074, 0.016219, -0.000137, -0.000137
#*# 	-0.059507, -0.026678, 0.002254, 0.004734, 0.019131, -0.030431, -0.064968
#*# 	-0.000424, -0.000424, 0.012619, 0.005217, 0.046705, -0.013868, -0.013868
#*# 	0.012089, 0.012089, 0.013851, 0.057967, 0.015928, -0.039137, -0.039137
#*# 	0.026729, 0.026729, 0.026729, 0.026729, 0.026729, 0.026729, 0.026729
#*# tension = 0.2
#*# min_x = -120.0
#*# algo = bicubic
#*# y_count = 7
#*# mesh_y_pps = 2
#*# min_y = -119.99
#*# x_count = 7
#*# max_y = 119.99
#*# mesh_x_pps = 2
#*# max_x = 120.0
#*#
#*# [extruder]
#*#
#*# [heater_bed]
